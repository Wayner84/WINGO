<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rogue‚ÄëLike Bingo ‚Äî Deluxe</title>
  <style>
    :root{
      --bg:#0c0f16; --panel:#121826; --card:#182033; --muted:#95a1b7; --text:#eef3ff; --accent:#7dd3fc; --gold:#ffd166; --line:#f59e0b;
      --grid:#1d2437; --mark:#2dd4bf; --btn:#1b2236; --btnh:#222b46;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:
      radial-gradient(1200px 600px at 15% -10%, #1d2540 0%, rgba(13,16,24,0) 60%),
      radial-gradient(900px 500px at 95% 20%, #1a233b 0%, rgba(13,16,24,0) 60%),
      linear-gradient(180deg,#0c0f16,#0b0e14 30% 70%,#0c0f16);
      color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Helvetica,Arial}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:rgba(18,24,38,.7);backdrop-filter: blur(10px);position:sticky;top:0;z-index:10;border-bottom:1px solid #20283c}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:0.3px}
    .brand svg{width:28px;height:28px}
    header .stat{display:flex;align-items:center;gap:8px;font-weight:700}
    header .stat span{display:inline-flex;gap:6px;align-items:center;background:var(--card);padding:7px 11px;border-radius:12px;border:1px solid #24304b}
    .ico{width:16px;height:16px;display:inline-block}

    .wrap{display:grid;grid-template-columns: 1fr 360px; gap:16px; padding:16px; max-width:1280px; margin:0 auto}

    /* Board */
    .board{background:var(--panel);border:1px solid #20283c;border-radius:16px;padding:16px;box-shadow:0 20px 40px rgb(0 0 0 / .35)}
    .board h2{margin:0 0 12px 2px;font-size:18px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;background:linear-gradient(180deg,#141b2b,#121623);border-radius:12px;padding:8px;border:1px solid #24304b}
    .cell{aspect-ratio:1;background:var(--grid);border:1px solid #2a3553;border-radius:12px;display:flex;align-items:center;justify-content:center;
          font-size:28px;font-weight:900;letter-spacing:1px;position:relative;cursor:pointer;user-select:none;transition:transform .06s ease, box-shadow .2s}
    .cell:hover{transform:translateY(-1px)}
    .cell.free{background:linear-gradient(135deg,#233e59,#2a3c63)}
    .cell.marked{background:linear-gradient(180deg,#1b3a43,#173235);border-color:#1d3d42;box-shadow: inset 0 0 0 2px var(--mark)}
    .cell .tiny{position:absolute;bottom:6px;right:10px;font-size:11px;color:var(--muted)}
    .cell.bingo{animation:glow 1.2s ease both}
    @keyframes glow{0%{box-shadow:inset 0 0 0 2px var(--mark),0 0 0 0 rgba(245,158,11,.6)} 100%{box-shadow:inset 0 0 0 2px var(--line),0 0 50px 20px rgba(245,158,11,0)} }

    .pill{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;border:1px dashed #2a3553;color:var(--muted);font-size:12px}

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;background:var(--btn);border:1px solid #2a3553;border-radius:12px;padding:10px 14px;color:var(--text);font-weight:800;cursor:pointer;transition:transform .05s ease, background .2s}
    .btn:hover{background:var(--btnh)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,#24314b,#202a42);border-color:#334066}
    .btn.success{background:linear-gradient(180deg,#1f3a2a,#1b3225);border-color:#2a4b3a}
    .btn.warn{background:linear-gradient(180deg,#3a281f,#2d211c);border-color:#52382e}

    .side{display:grid;gap:16px}
    .card{background:var(--panel);border:1px solid #20283c;border-radius:16px;padding:14px}
    .card h3{margin:0 0 10px;font-size:16px;color:var(--muted);display:flex;align-items:center;gap:8px}

    .boss{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,#171c28,#141925);padding:12px;border-radius:12px;border:1px solid #24304b}
    .boss .hpwrap{flex:1;display:grid;gap:6px}
    .boss .hpbar{height:12px;background:#121724;border-radius:999px;overflow:hidden;border:1px solid #24304b}
    .boss .hp{height:100%;background:linear-gradient(90deg,#34d399,#22c55e);width:100%}

    .shop-list{display:grid;grid-template-columns:1fr;gap:10px}
    .item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;background:linear-gradient(180deg,#141a2a,#121826);padding:10px;border-radius:12px;border:1px solid #24304b}
    .item .emoji{font-size:22px}
    .item .ttl{font-weight:900}
    .item .desc{font-size:12px;color:var(--muted)}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a3553;color:var(--muted)}

    .log{height:150px;background:#0f1421;border-radius:12px;padding:10px;border:1px solid #24304b;overflow:auto;font-size:13px;line-height:1.35}
    .log p{margin:.2em 0}

    .inv{display:flex;flex-wrap:wrap;gap:8px}
    .inv .chip{display:flex;align-items:center;gap:6px;background:#0f1421;border:1px solid #24304b;padding:6px 10px;border-radius:999px;font-size:12px}

    footer{padding:14px 20px;color:#7c8498;text-align:center}
    .small{font-size:12px;color:var(--muted)}

    .preview{display:flex;gap:6px}
    .ball{min-width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:999px;border:1px solid #2a3553;background:radial-gradient(circle at 30% 30%, #263154, #1a223a);font-weight:900}
  </style>
</head>
<body>
  <header>
    <div class="brand" title="Rogue‚ÄëLike Bingo">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="#7dd3fc" stroke-width="2"/><path d="M7 12h10M12 7v10" stroke="#7dd3fc" stroke-width="2"/></svg>
      Rogue‚ÄëLike Bingo
    </div>
    <div class="stat">
      <span title="Hearts"><svg class="ico" viewBox="0 0 24 24"><path d="M12 21s-7-4.35-9.5-8A5.5 5.5 0 1 1 12 6a5.5 5.5 0 1 1 9.5 7c-2.5 3.65-9.5 8-9.5 8z" fill="#ff6b6b"/></svg> <strong id="hearts">3</strong></span>
      <span title="Coins"><svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="#ffd166"/><circle cx="12" cy="12" r="6" fill="#ffeb9c"/></svg> <strong id="coins">0</strong></span>
      <span title="Floor"><svg class="ico" viewBox="0 0 24 24"><path d="M4 20h16M6 16h12M8 12h8M10 8h4M12 4h0" stroke="#7dd3fc" stroke-width="2"/></svg> <strong id="floor">1</strong></span>
      <span id="callsCap" class="pill" title="Calls this round">üì£ Calls: <b id="calls">0</b>/<b id="cap">30</b></span>
    </div>
    <div class="row">
      <button class="btn" id="newGame">New Game</button>
      <button class="btn" id="saveBtn" title="Save to this browser">Save</button>
      <button class="btn" id="loadBtn" title="Load from this browser">Load</button>
    </div>
  </header>

  <div class="wrap">
    <section class="board">
      <h2>Board <span class="pill" id="comboMeter" title="Bonus damage for consecutive hits">Combo +0</span></h2>
      <div id="grid" class="grid" aria-label="Bingo Board"></div>
      <div class="row" style="margin-top:12px;align-items:center">
        <button class="btn primary" id="nextCall">Call Next (Space)</button>
        <button class="btn" id="freeMark">Use Free Dauber</button>
        <span class="pill" id="deckInfo">Deck: 75</span>
        <div class="preview" id="preview"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>Call Log</h3>
        <div id="log" class="log" aria-live="polite"></div>
      </div>
    </section>

    <aside class="side">
      <div class="card">
        <h3>Boss</h3>
        <div class="boss">
          <strong id="bossName">Dungeon Slime</strong>
          <div class="hpwrap">
            <div class="hpbar"><div id="hp" class="hp"></div></div>
            <div class="row small"><span id="hpTxt">20/20</span></div>
          </div>
          <button class="btn warn" id="useBomb" title="One use per round">üí£ Use Bomb</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn success" id="endRound" title="Finish the round early">End Round</button>
          <span class="pill" id="tips">Complete lines to deal big damage!</span>
        </div>
      </div>

      <div class="card" id="shopCard">
        <h3>Shop</h3>
        <div id="shop" class="shop-list"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="reroll">Reroll (3ü™ô)</button>
          <button class="btn" id="skipShop">Skip</button>
        </div>
      </div>

      <div class="card">
        <h3>Inventory</h3>
        <div id="inv" class="inv"></div>
      </div>

      <div class="card">
        <h3>Rules</h3>
        <ul class="small" style="margin:6px 0 0 18px;line-height:1.45">
          <li>Press <b>Space</b> or click <b>Call Next</b>.</li>
          <li>Matches auto‚Äëmark; lines = massive damage.</li>
          <li>Items stack. Some grant previews, combo damage, bombs, and more.</li>
          <li>Beat the boss before calls run out or lose a ‚ù§.</li>
        </ul>
      </div>
    </aside>
  </div>

  <footer>
    <span class="small">Single‚Äëfile prototype ‚Äî have fun!</span>
  </footer>

  <script>
  // ======= Game State =======
  const state = {
    hearts: 3,
    coins: 0,
    floor: 1,
    callsUsed: 0,
    callCapBase: 30,
    callCapBonus: 0,
    rerollCostBase: 3,
    deck: [],
    board: [],
    markedSet: new Set(),
    boss: {name:"Dungeon Slime", hp:20, max:20},
    inventory: [], // item ids
    freeDauberUsed:false,
    combo: 0,
    bombUsed: false,
  };

  // ======= Items Catalog (more items!) =======
  // id: { name, emoji, desc, cost }
  const ITEMS = {
    sharp:   { name:"Sharp Marker",  emoji:"‚úíÔ∏è", desc:"+1 damage per mark.", cost:6 },
    lucky:   { name:"Lucky Charm",   emoji:"üçÄ", desc:"+10% crit chance (2√ó dmg).", cost:7 },
    golden:  { name:"Golden Dab",    emoji:"üí∞", desc:"+1 coin per mark.", cost:6 },
    vamp:    { name:"Vampiric Ink",  emoji:"üßõ", desc:"Heal 1 ‚ù§ on each line.", cost:9 },
    scatter: { name:"Scattershot",   emoji:"üí•", desc:"Crit also marks a random neighbor.", cost:8 },
    shield:  { name:"Extra Heart",   emoji:"üõ°Ô∏è", desc:"+1 ‚ù§ (max & current)", cost:10 },
    extra:   { name:"Extra Balls",   emoji:"‚ûï", desc:"+2 calls per round.", cost:7 },
    freed:   { name:"Free Dauber",   emoji:"‚≠ê", desc:"Once/round mark any cell.", cost:5 },
    // New
    scry:    { name:"Scrying Orb",   emoji:"üîÆ", desc:"Preview the next 3 balls.", cost:7 },
    combo:   { name:"Combo Counter", emoji:"üßÆ", desc:"+1 dmg per consecutive hit (max +5).", cost:8 },
    chain:   { name:"Chain Mark",    emoji:"‚õìÔ∏è", desc:"Completing a line marks a random cell.", cost:9 },
    coupon:  { name:"Reroll Coupon", emoji:"üè∑Ô∏è", desc:"Reroll costs ‚àí1 (min 0).", cost:5 },
    bribe:   { name:"Boss Bribe",    emoji:"ü™ô", desc:"Boss starts with ‚àí8% HP per stack.", cost:9 },
    lucky7:  { name:"Lucky Seven",   emoji:"7Ô∏è‚É£", desc:"Balls divisible by 7: +2ü™ô & bonus mark.", cost:8 },
    key:     { name:"Treasure Key",  emoji:"üóùÔ∏è", desc:"+3ü™ô more on victory.", cost:6 },
    bomb:    { name:"Pocket Bomb",   emoji:"üí£", desc:"Once/round: deal 15 dmg per stack.", cost:10 },
  };
  const ITEM_IDS = Object.keys(ITEMS);

  // ======= Helpers =======
  const $ = sel => document.querySelector(sel);
  const logEl = $('#log');
  const gridEl = $('#grid');
  const hpBar = $('#hp');
  const hpTxt = $('#hpTxt');
  const heartsEl = $('#hearts');
  const coinsEl = $('#coins');
  const floorEl = $('#floor');
  const callsEl = $('#calls');
  const capEl = $('#cap');
  const deckInfo = $('#deckInfo');
  const bossNameEl = $('#bossName');
  const invEl = $('#inv');
  const shopEl = $('#shop');
  const comboMeter = $('#comboMeter');
  const previewEl = $('#preview');
  const useBombBtn = $('#useBomb');

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
  function randChoice(a){ return a[Math.floor(Math.random()*a.length)] }
  function addLog(text){ const p=document.createElement('p'); p.textContent=text; logEl.appendChild(p); logEl.scrollTop = logEl.scrollHeight; }
  function hasItem(id){ return state.inventory.includes(id) }
  function itemCount(id){ return state.inventory.filter(x=>x===id).length }

  function updateHeader(){
    heartsEl.textContent = state.hearts;
    coinsEl.textContent = state.coins;
    floorEl.textContent = state.floor;
    callsEl.textContent = state.callsUsed;
    capEl.textContent = state.callCapBase + state.callCapBonus*itemCount('extra');
    comboMeter.textContent = `Combo +${state.combo}`;
    updateRerollText();
  }

  function setBoss(name, hp){ state.boss = {name, hp, max:hp}; bossNameEl.textContent=name; updateBossHP() }
  function updateBossHP(){
    const pct = Math.max(0, state.boss.hp)/state.boss.max*100;
    hpBar.style.width = pct+"%";
    hpTxt.textContent = Math.max(0,state.boss.hp) + "/" + state.boss.max;
  }

  function calcMarkDamage(){
    let dmg = 1 + itemCount('sharp') + state.combo;
    // crit
    let critChance = 0.00 + 0.10*itemCount('lucky');
    const crit = Math.random() < critChance;
    if(crit) dmg *= 2;
    return {dmg, crit};
  }

  function awardCoin(n=1){ state.coins += n + itemCount('golden'); }

  function neighbors(idx){
    const r = Math.floor(idx/5), c = idx%5; const res=[];
    for(const [dr,dc] of [[1,0],[-1,0],[0,1],[0,-1]]){
      const rr=r+dr, cc=c+dc; if(rr>=0&&rr<5&&cc>=0&&cc<5) res.push(rr*5+cc)
    } return res
  }

  // ======= Board =======
  function newBoard(){
    const nums = shuffle([...Array(75).keys()].map(i=>i+1)).slice(0,25);
    state.board = nums.map((n,i)=>({n, marked:i===12}));
    state.markedSet = new Set(state.board.map((b,i)=>b.marked?i:null).filter(x=>x!==null));
    renderBoard();
  }

  function renderBoard(){
    gridEl.innerHTML = '';
    state.board.forEach((cell, i)=>{
      const d=document.createElement('button');
      d.className = 'cell' + (i===12?' free':'') + (cell.marked?' marked':'');
      d.setAttribute('data-idx', i);
      d.title = 'Cell '+(i+1);
      d.innerHTML = `<span>${cell.n}</span>${i===12?'<span class="tiny">FREE</span>':''}`;
      d.addEventListener('click', ()=> tryManualMark(i));
      gridEl.appendChild(d);
    })
  }

  function markCell(i, {silent=false, fromCrit=false}={}){
    if(state.board[i].marked) return false;
    state.board[i].marked = true;
    state.markedSet.add(i);
    const el = gridEl.querySelector(`[data-idx="${i}"]`);
    if(el) el.classList.add('marked');
    if(!silent){
      const {dmg, crit} = calcMarkDamage();
      state.boss.hp -= dmg;
      awardCoin(1);
      if(crit){ addLog(`CRIT! Mark dealt ${dmg} damage.`); if(hasItem('scatter')&&!fromCrit){ const ns=neighbors(i).filter(j=>!state.board[j].marked); if(ns.length){ markCell(randChoice(ns), {silent:true, fromCrit:true}); addLog('Scattershot marked a neighbor!') } } }
      updateBossHP();
      checkLines(i);
      checkWinLose();
    }
    return true;
  }

  function tryManualMark(i){
    if(hasItem('freed') && !state.freeDauberUsed){
      if(markCell(i)){
        state.freeDauberUsed = true;
        addLog('Used Free Dauber.');
      }
    }
  }

  function indicesRow(r){ return [0,1,2,3,4].map(c=>r*5+c) }
  function indicesCol(c){ return [0,1,2,3,4].map(r=>r*5+c) }
  const diag1=[0,6,12,18,24];
  const diag2=[4,8,12,16,20];

  function isLineMarked(idxs){ return idxs.every(i=>state.board[i].marked) }

  const completedLines = new Set();
  function lineKey(idxs){ return idxs.join('-') }

  function checkLines(lastIdx){
    const r = Math.floor(lastIdx/5), c = lastIdx%5;
    const sets=[indicesRow(r), indicesCol(c), diag1, diag2];
    for(const s of sets){
      const key=lineKey(s);
      if(isLineMarked(s) && !completedLines.has(key)){
        completedLines.add(key);
        const lineDmg = 10 + 4*state.floor + 2*itemCount('sharp');
        state.boss.hp -= lineDmg;
        if(hasItem('vamp')){ state.hearts = Math.min(state.hearts+1, 3 + itemCount('shield')); addLog('Vampiric Ink healed ‚ù§!') }
        highlightLine(s);
        addLog(`BINGO line! Dealt ${lineDmg} damage.`);
        awardCoin(3);
        // Chain mark
        if(hasItem('chain')){
          const choices = state.board.map((b,i)=>!b.marked?i:null).filter(x=>x!==null);
          if(choices.length){ markCell(randChoice(choices)); addLog('Chain Mark triggered!'); }
        }
        updateHeader();
        updateBossHP();
      }
    }
  }

  function highlightLine(idxs){ idxs.forEach(i=> gridEl.querySelector(`[data-idx="${i}"]`)?.classList.add('bingo')) }

  // ======= Deck / Calls =======
  function newDeck(){ state.deck = shuffle([...Array(75).keys()].map(i=>i+1)); updateDeckInfo(); renderPreview(); }
  function updateDeckInfo(){ deckInfo.textContent = `Deck: ${state.deck.length}` }
  function renderPreview(){
    previewEl.innerHTML = '';
    if(!hasItem('scry')) return;
    const k = Math.min(3, state.deck.length);
    for(let i=1;i<=k;i++){
      const n = state.deck[state.deck.length - i];
      const b = document.createElement('div'); b.className='ball'; b.textContent=n; previewEl.appendChild(b);
    }
  }

  function callNext(){
    const cap = state.callCapBase + state.callCapBonus*itemCount('extra');
    if(state.callsUsed >= cap){ addLog('No calls left this round!'); return }
    if(state.deck.length===0){ addLog('Deck is empty.'); return }

    const n = state.deck.pop();
    state.callsUsed++;
    updateDeckInfo(); updateHeader(); renderPreview();
    addLog(`Ball: ${n}`);

    // Lucky Seven bonus
    if(hasItem('lucky7') && n%7===0){
      state.coins += 2;
      const candidates = state.board.map((b,i)=>!b.marked?i:null).filter(x=>x!==null);
      if(candidates.length){ markCell(randChoice(candidates)); }
      addLog('Lucky Seven! +2ü™ô and a bonus mark.');
      updateHeader();
    }

    let hit=false;
    state.board.forEach((cell, i)=>{ if(cell.n===n){ markCell(i); hit=true; }});
    // Combo handling
    if(hasItem('combo')){ state.combo = hit ? Math.min(5, state.combo+1) : 0; comboMeter.textContent = `Combo +${state.combo}`; }

    checkWinLose();
  }

  // ======= Rounds & Progression =======
  function startRound(){
    state.callsUsed = 0;
    state.freeDauberUsed = false;
    state.combo = 0;
    state.bombUsed = false;
    completedLines.clear();
    newDeck();
    newBoard();
    const hp = Math.floor(20 + (state.floor-1)*12 + Math.pow(state.floor,1.25)*6);
    const names=["Dungeon Slime","Crypt Skeleton","Cobalt Sentinel","Ember Wraith","Gilded Gorgon","Chaos Hydra"];
    setBoss(randChoice(names), hp);
    // Bribe applies after boss is set
    const br = itemCount('bribe');
    if(br>0){ const cut = Math.floor(state.boss.max * 0.08 * br); state.boss.hp = Math.max(1, state.boss.hp - cut); addLog(`Your bribe weakens the boss by ${cut} HP.`); updateBossHP(); }
    addLog(`‚Äî Floor ${state.floor}: ${state.boss.name} appears with ${state.boss.hp}/${state.boss.max} HP ‚Äî`);
    renderInventory();
    populateShop();
    updateHeader();
    updateBombButton();
  }

  function endRound(victory){
    if(victory){
      let bonus = 5 + state.floor*2 + 3*itemCount('key');
      state.coins += bonus;
      addLog(`Victory! +${bonus} coins.`);
      state.floor++;
      startRound();
    } else {
      state.hearts -= 1;
      if(state.hearts<=0){ gameOver(); return }
      addLog('You lost the round. -1 ‚ù§');
      startRound();
    }
  }

  function checkWinLose(){
    if(state.boss.hp<=0){ setTimeout(()=> endRound(true), 250); }
    else {
      const cap = state.callCapBase + state.callCapBonus*itemCount('extra');
      if(state.callsUsed>=cap && state.boss.hp>0){ setTimeout(()=> endRound(false), 250); }
    }
  }

  function gameOver(){
    addLog('üíÄ Game Over! Starting a fresh run...');
    state.hearts = 3 + itemCount('shield');
    state.coins = 0;
    state.floor = 1;
    startRound();
  }

  // ======= Shop =======
  let currentShop = [];
  function offerPool(){
    // Weighted: slightly prefer affordable items on low floors
    const pool = [];
    for(const id of ITEM_IDS){
      const w = (ITEMS[id].cost >= 9 && state.floor<3) ? 1 : 2;
      for(let i=0;i<w;i++) pool.push(id);
    }
    return pool;
  }
  function populateShop(){ currentShop = shuffle(offerPool()).slice(0,3); renderShop(); }

  function renderShop(){
    shopEl.innerHTML = '';
    currentShop.forEach(id=>{
      const it = ITEMS[id];
      const row=document.createElement('div');
      row.className='item';
      row.innerHTML = `
        <div class="emoji">${it.emoji}</div>
        <div>
          <div class="ttl">${it.name}</div>
          <div class="desc">${it.desc}</div>
        </div>
        <div class="row">
          <span class="tag">${it.cost}ü™ô</span>
          <button class="btn" data-buy="${id}">Buy</button>
        </div>`;
      shopEl.appendChild(row);
    })
    shopEl.querySelectorAll('[data-buy]').forEach(btn=> btn.addEventListener('click', onBuy));
  }

  function onBuy(e){
    const id = e.currentTarget.getAttribute('data-buy');
    const it = ITEMS[id];
    if(state.coins < it.cost){ addLog('Not enough coins.'); return }
    state.coins -= it.cost;
    state.inventory.push(id);
    addLog(`Bought ${it.name}.`);
    if(id==='shield'){ state.hearts += 1; }
    if(id==='extra'){ state.callCapBonus += 1; }
    renderInventory();
    updateHeader();
    updateBombButton();
    renderPreview();
  }

  function renderInventory(){
    invEl.innerHTML='';
    const counts = {};
    state.inventory.forEach(id=> counts[id]=(counts[id]||0)+1);
    Object.entries(counts).forEach(([id,n])=>{
      const it=ITEMS[id];
      const chip=document.createElement('div');
      chip.className='chip'; chip.title = it.desc;
      chip.innerHTML = `<span>${it.emoji}</span><span>${it.name}</span><span class="tag">√ó${n}</span>`;
      invEl.appendChild(chip);
    })
  }

  // ======= Save / Load =======
  function save(){
    const data = JSON.stringify(state);
    localStorage.setItem('rogueBingoSaveDeluxe', data);
    addLog('Saved.');
  }
  function load(){
    const data = localStorage.getItem('rogueBingoSaveDeluxe');
    if(!data){ addLog('No save found.'); return }
    const obj = JSON.parse(data);
    Object.assign(state, obj);
    renderBoard();
    renderInventory();
    renderShop();
    updateHeader();
    updateBossHP();
    updateDeckInfo();
    renderPreview();
    updateBombButton();
    addLog('Loaded.');
  }

  // ======= Bomb =======
  function updateBombButton(){
    const have = itemCount('bomb');
    useBombBtn.style.display = have? 'inline-flex':'none';
    useBombBtn.disabled = state.bombUsed;
    useBombBtn.textContent = state.bombUsed? 'üí£ Used' : `üí£ Use Bomb`;
  }
  function useBomb(){
    const stacks = itemCount('bomb');
    if(!stacks || state.bombUsed) return;
    const dmg = 15 * stacks;
    state.boss.hp -= dmg; updateBossHP(); addLog(`Bomb explodes for ${dmg} damage!`);
    state.bombUsed = true; updateBombButton(); checkWinLose();
  }

  // ======= Controls =======
  $('#nextCall').addEventListener('click', callNext);
  $('#freeMark').addEventListener('click', ()=>{
    if(hasItem('freed')){
      if(state.freeDauberUsed){ addLog('Free Dauber already used this round.'); }
      else addLog('Click any cell to mark it.');
    } else addLog('Buy Free Dauber in the shop first.');
  });
  $('#endRound').addEventListener('click', ()=>{ if(state.boss.hp>0){ addLog('You fled early. No rewards.'); endRound(false);} });
  function rerollCost(){ return Math.max(0, state.rerollCostBase - itemCount('coupon')); }
  function updateRerollText(){ $('#reroll').textContent = `Reroll (${rerollCost()}ü™ô)` }
  $('#reroll').addEventListener('click', ()=>{
    const cost = rerollCost();
    if(state.coins>=cost){ state.coins-=cost; populateShop(); updateHeader(); addLog('Shop rerolled.'); }
    else addLog(`Need ${cost} coins to reroll.`);
  });
  $('#skipShop').addEventListener('click', ()=>{ populateShop(); addLog('Shop refreshed.'); });
  $('#newGame').addEventListener('click', ()=>{ if(confirm('Start a new run?')){ resetRun(); } });
  $('#saveBtn').addEventListener('click', save);
  $('#loadBtn').addEventListener('click', load);
  useBombBtn.addEventListener('click', useBomb);

  document.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); callNext(); } });

  function resetRun(){
    state.hearts = 3;
    state.coins = 0;
    state.floor = 1;
    state.inventory = [];
    state.callCapBonus = 0;
    startRound();
  }

  // ======= Boot =======
  resetRun();
  </script>
</body>
</html>
